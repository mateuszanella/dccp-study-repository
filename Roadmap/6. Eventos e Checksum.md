<!-- Em progresso -->

# Eventos e Checksum

Esta seção descreve como as conexões DCCP transitam entre estados e quais pacotes são enviados quando. Note que a negociação de recursos ocorre em paralelo com as transições de estado em toda a conexão descritas aqui.

## Eventos

### Estabelecimento de conexão

A fase de inicialização das conexões DCCP consiste em um handshake de três vias: um pacote DCCP-Request inicial enviado pelo cliente, um DCCP-Response enviado pelo servidor em resposta e, finalmente, um reconhecimento do cliente, geralmente através de um pacote DCCP-Ack ou DCCP-DataAck. O cliente move-se do estado REQUEST para PARTOPEN e, finalmente, para OPEN. O servidor move-se de LISTEN para RESPOND e, finalmente, para OPEN.

| Estado do Cliente | Estado do Servidor      |
| ----------------- | ----------------------- |
| CLOSED            | LISTEN                  |
| REQUEST   -->     | Request        -->      |
|                   | Response       <--      | RESPOND |
| PARTOPEN  -->     | Ack, DataAck     -->    |
|                   | Data, Ack, DataAck  <-- | OPEN    |
| OPEN      <->     | Data, Ack, DataAck  <-> | OPEN    |

#### Requisição do cliente

Quando um cliente decide iniciar uma conexão, ele entra no estado de REQUEST, escolhe um número de sequência inicial e envia um pacote DCCP-Request para o servidor pretendido usando esse número de sequência. Esses pacotes DCCP-Request geralmente contêm opções de negociação de recursos que iniciam negociações para vários parâmetros de conexão, como IDs de controle de congestionamento preferenciais para cada meia-conexão. Além disso, eles podem transportar dados de aplicativos, mas o cliente deve estar ciente de que o servidor pode não aceitar esses dados.

Um cliente no estado de REQUEST deve usar um temporizador de espera exponencial para enviar novos pacotes DCCP-Request se não receber resposta. As retransmissões devem começar aproximadamente após um segundo, com intervalos aumentando para não menos que um pacote a cada 64 segundos, seguindo uma estratégia de retransmissão semelhante à dos TCP SYNs. O cliente pode desistir de seus DCCP-Requests após algum tempo (por exemplo, 3 minutos) e, nesse caso, deve enviar um pacote DCCP-Reset para o servidor com código de reset 2, "Abortado", para limpar o estado caso uma ou mais das solicitações realmente tenham chegado. Ao receber um DCCP-Response do servidor, o cliente deixa o estado de REQUEST e entra no estado de PARTOPEN.

#### Resposta do servidor

Na segunda fase do handshake de três vias, o servidor transita do estado LISTEN para RESPOND e envia uma mensagem DCCP-Response ao cliente. Nesta fase, o servidor geralmente especifica as funcionalidades que gostaria de usar, tanto das solicitadas pelo cliente quanto adicionais. Entre essas opções está o mecanismo de controle de congestionamento que o servidor pretende utilizar. O servidor pode responder a um pacote DCCP-Request com um pacote DCCP-Reset para recusar a conexão, utilizando códigos de reset relevantes como "Conexão Recusada", "Código de Serviço Inválido" ou "Servidor Ocupado".

O servidor não deve retransmitir pacotes DCCP-Response; o cliente fará a retransmissão do DCCP-Request, se necessário. O servidor detectará que o DCCP-Request retransmitido se aplica a uma conexão existente devido às suas portas de origem e destino. Cada DCCP-Request válido recebido enquanto o servidor estiver no estado RESPOND deve elicitar um novo DCCP-Response. O servidor sai do estado RESPOND para OPEN quando recebe um DCCP-Ack válido do cliente, concluindo o handshake de três vias, ou para CLOSED após um timeout, enviando um DCCP-Reset para limpar o estado no cliente.

#### Finalização do handshake

Quando o cliente recebe um DCCP-Response do servidor, ele transita do estado de REQUEST para PARTOPEN e completa o handshake de três vias enviando um pacote DCCP-Ack para o servidor. Permanece em PARTOPEN até ter certeza de que o servidor recebeu algum pacote enviado pelo cliente a partir de PARTOPEN (seja o DCCP-Ack inicial ou um pacote posterior). Clientes no estado PARTOPEN que desejam enviar dados devem fazê-lo usando pacotes DCCP-DataAck, não DCCP-Data, pois estes últimos não contêm números de reconhecimento, tornando impossível para o servidor saber se o cliente recebeu o DCCP-Response. Além disso, se o DCCP-Response incluir um Init Cookie, esse Init Cookie deve ser incluído em cada pacote enviado em PARTOPEN.

> Um Init Cookie é uma opção utilizada pelo servidor DCCP para evitar a necessidade de manter qualquer estado até que o handshake de configuração da conexão de três vias seja concluído, semelhante ao conceito de TCP SYN cookies. Ele encapsula informações importantes da solicitação (DCCP-Request) e resposta (DCCP-Response) em um cookie opaco, como código de serviço, porta do servidor e opções relevantes, sendo tipicamente criptografado com uma chave secreta do servidor. Quando o servidor recebe o cookie de volta na resposta, pode decifrá-lo e instanciar todo o estado necessário para a conexão.

O único DCCP-Ack enviado ao entrar no estado PARTOPEN pode ser perdido pela rede. O cliente deve garantir que algum pacote seja eventualmente entregue. Um mecanismo preferencial seria um temporizador de aproximadamente 200 milissegundos, acionado sempre que um pacote é transmitido em PARTOPEN. Se esse temporizador expirar e o cliente ainda estiver em PARTOPEN, ele gera outro DCCP-Ack e ajusta o temporizador. Se o cliente permanecer em PARTOPEN por mais de 4MSL (8 minutos), deve redefinir a conexão com o código de reset 2, "Abortado". O cliente sai do estado PARTOPEN para OPEN ao receber um pacote válido diferente de DCCP-Response, DCCP-Reset ou DCCP-Sync do servidor.

#### Códigos de serviço

Cada DCCP-Request contém um Service Code de 32 bits, que identifica o serviço de nível de aplicativo ao qual a aplicação do cliente está tentando se conectar. Esses códigos devem corresponder a serviços e protocolos de aplicativos específicos, como por exemplo, um código para conexões de controle [SIP](https://ozekiphone.com/p_4397-rtp-vs.-sip.html/) e outro para conexões de áudio [RTP](https://ozekiphone.com/p_4397-rtp-vs.-sip.html). Os middleboxes, como firewalls, podem usar o Service Code para identificar a aplicação em execução em uma porta não padrão, desde que o cabeçalho DCCP não tenha sido criptografado. É obrigatório que cada socket DCCP, tanto aberto ativamente quanto passivamente, esteja associado a um Service Code, sendo que o aplicativo geralmente fornecerá esse código. Sockets ativos devem ter exatamente um Service Code, enquanto sockets passivos podem, a critério da implementação, estar associados a mais de um Service Code para permitir que múltiplas aplicações ou versões diferentes da mesma aplicação escutem na mesma porta, diferenciadas pelo Service Code.

Se o Service Code do DCCP-Request não corresponder a nenhum dos Service Codes do servidor para a porta especificada, o servidor deve rejeitar a solicitação enviando um pacote DCCP-Reset com Reset Code 8, "Bad Service Code". Middleboxes também podem enviar tal DCCP-Reset em resposta a pacotes cujo Service Code seja considerado inadequado. Esses códigos são atribuídos pela IANA e não são específicos do DCCP, seguindo diretrizes como alocação "First Come First Served" e outras políticas delineadas em documentos como o [RFC2434](https://datatracker.ietf.org/doc/html/rfc2434).

### Transferência de dados

Durante a fase central de transferência de dados da conexão DCCP, tanto o servidor quanto o cliente estão no estado OPEN. O DCCP A envia pacotes DCCP-Data e DCCP-DataAck para o DCCP B em resposta a eventos de aplicativo no host A. Esses pacotes são controlados por congestionamento pelo CCID da meia-conexão A-para-B. Por outro lado, os pacotes DCCP-Ack enviados pelo DCCP A são controlados pelo CCID da meia-conexão B-para-A. Geralmente, o DCCP A incluirá informações de reconhecimento nos pacotes DCCP-Data quando possível, criando pacotes DCCP-DataAck. Os pacotes DCCP-Ack são usados quando não há dados para enviar do DCCP A para o DCCP B, ou quando o estado de congestão do CCID de A-para-B não permite o envio de dados.

Durante essa fase, também podem ocorrer pacotes DCCP-Sync e DCCP-SyncAck. Uma distinção importante dos pacotes DCCP-Sync em relação a outros tipos de pacotes é que o DCCP-Sync exige um reconhecimento imediato. Ao receber um pacote DCCP-Sync válido, um endpoint DCCP deve imediatamente gerar e enviar uma resposta DCCP-SyncAck. O Número de Reconhecimento nesse DCCP-SyncAck deve ser igual ao Número de Sequência do DCCP-Sync. Algumas implementações do DCCP podem optar por iniciar a negociação de recursos somente após o estado OPEN ser alcançado, o que pode atrasar a transferência de dados. Dados recebidos durante esse período devem ser rejeitados e relatados usando um Bloco de Queda de Dados com Código de Queda 0, Restrições de Protocolo.

### Finalização da conexão

A terminação da conexão DCCP utiliza um handshake composto por um pacote opcional DCCP-CloseReq, um pacote DCCP-Close e um pacote DCCP-Reset. O servidor transita do estado OPEN, possivelmente passando pelo estado CLOSEREQ, para CLOSED. O cliente transita do estado OPEN, passando por CLOSING até TIMEWAIT, e após um tempo de espera de 2MSL (4 minutos), para CLOSED.

A sequência DCCP-CloseReq, DCCP-Close, DCCP-Reset é usada quando o servidor decide encerrar a conexão, mas não deseja permanecer no estado TIMEWAIT:

| Cliente     | Servidor                  |
| ----------- | ------------------------- |
| OPEN        | OPEN                      |
|             | CLOSEREQ <-- CloseReq     |
| CLOSING --> | Close -->                 |
|             | Reset <-- CLOSED (LISTEN) |
| TIMEWAIT    |
| CLOSED      |

Quando o cliente decide fechar a conexão, ocorre uma sequência mais curta:

| Cliente     | Servidor                  |
| ----------- | ------------------------- |
| CLOSING --> | Close -->                 |
|             | Reset <-- CLOSED (LISTEN) |
| TIMEWAIT    |
| CLOSED      |

Finalmente, o servidor pode decidir permanecer no estado TIMEWAIT:

| Cliente    | Servidor          |
| ---------- | ----------------- |
|            | Close <-- CLOSING |
| CLOSED --> | Reset -->         |
|            | TIMEWAIT          |
|            | CLOSED (LISTEN)   |

Durante o encerramento de uma conexão DCCP, independentemente se a terminação é limpa (devido ao fechamento da aplicação: Reset Code 1, "Closed") ou não, o receptor do pacote DCCP-Reset mantém o estado TIMEWAIT para a conexão. Esse estado, semelhante ao do TCP, garante que nenhuma conexão que possa duplicar os endereços e portas da conexão atual seja iniciada enquanto pacotes antigos ainda podem estar na rede, evitando conflitos e problemas de duplicação de conexões. A sequência de encerramento segue um padrão: o receptor de um pacote DCCP-CloseReq válido deve responder com um pacote DCCP-Close, e o receptor de um pacote DCCP-Close válido deve responder com um pacote DCCP-Reset com Reset Code 1, "Closed", encerrando assim a conexão de forma uniforme, ao contrário do TCP que possui mecanismos distintos de terminação ([FIN e RST](https://www.baeldung.com/cs/tcp-fin-vs-rst)).

Durante os estados CLOSEREQ e CLOSING, os endpoints devem retransmitir os pacotes DCCP-CloseReq e DCCP-Close, respectivamente, até saírem desses estados. O intervalo de retransmissão inicial é configurado para duas vezes o tempo de ida e volta e deve ser ajustado para não menos que uma vez a cada 64 segundos se não houver resposta relevante. Apenas o servidor pode enviar um pacote DCCP-CloseReq ou entrar no estado CLOSEREQ, e ao receber um pacote DCCP-CloseReq válido, o servidor deve responder com um pacote DCCP-Sync e ignorar o DCCP-CloseReq em outros casos. Os pacotes DCCP-Data, DCCP-DataAck e DCCP-Ack recebidos nos estados CLOSEREQ ou CLOSING podem ser processados ou ignorados conforme necessário.

> Os endpoints do DCCP geram pacotes DCCP-Reset para encerrar conexões de forma anormal, utilizando diferentes códigos de reset dependendo do estado da conexão e tomando os números de sequência e reconhecimento do pacote recebido em resposta para estados sem variáveis de sequência associadas.

### Diagrama de estado do DCCP

As transições de estados mais comuns discutidas anteriormente podem ser resumidas nesse diagrama:

![Diagrama de estado do DCCP](../static/DCCP_State_Diagram.png)

---

## Checksum

---

> Esse repositório é apenas um overview do protocolo DCCP. Para mais informações, consulte a [RFC 4340](https://datatracker.ietf.org/doc/rfc4340/).

---

[Próximo: Sistema de Controle de Congestão](7.%20Congestão.md)